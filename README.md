# Blablador NLI Backend

An integrated system for segmenting citing sentences into discrete claims and testing those claims against the content of cited sources. 

+**Status – alpha / work-in-progress. Expect breaking changes and bugs.**

## Table of Contents
- [Upstream](#upstream)
- [Features](#features)
- [Requirements](#requirements)
- [Installation](#installation)
- [Configuration](#configuration)
- [Usage](#usage)
  - [Backend (FastAPI)](#backend-fastapi)
  - [Frontend (Streamlit)](#frontend-streamlit)
  - [Command-line Interface](#command-line-interface)
- [Project Structure](#project-structure)
- [Modules](#modules)
- [Contributing](#contributing)
- [License](#license)

## Upstream
- This repo continues from https://github.com/bozo32/citation-checking-poc 
- It takes the CSV generated by that project (which contains cited article and citing sentence on a row) as input

## Features
- Parses TEI-XML of the cited articles into sentences retaining metadata.
- Stores cited sentences in FAISS 
- Segments citing sentences into independent claims
- Uses similarity of cited sentences to citing segment to filter
- Uses NLI models to filter cited sentences found similar
- Uses OpenAI compliant API for a LLM to pick (and justify selection of) strongest entailing and strongest contradicting evidence from cited article 
- Web UI built with Streamlit supports interactive segmentation and citation checking.
- FastAPI backend exposing endpoints for segmentation, progress tracking, and index prebuild.

## Requirements
- Python 3.8 or higher
- FAISS (CPU or GPU)
- pip

## Installation
```bash
git clone https://github.com/your-org/blablador-nli-backend.git
cd blablador-nli-backend
pip install -r requirements.txt
```

## Configuration
- runs with python application.py --api_key (key) --api_base (base url)
- works with blablador. not tested with others

## Usage

1. Drag and drop your CSV and TEI XML files into sidebar  
2. wait for blablador to return list of live models and then select one  
3. Start segmentation and wait while it processes
4. Edit segments for clarity
5. submit segments for processing
6. download JSON

## Project Structure
```
.
├── backend
│   ├── main.py        # FastAPI application entrypoint
│   ├── bl_client.py   # Blablador API client for completions & embeddings
│   ├── parser.py      # TEI & CSV parsing utilities
│   ├── retriever.py   # FAISS index builder and searcher
│   ├── nli.py         # NLI classification (HF pipelines)
│   ├── schemas.py     # Pydantic models for API payloads
│   └── utils.py       # Shared utilities (text cleaning, CSV reading)
├── ui.py              # Streamlit UI for segmentation & checking
├── application.py     # CLI launcher for backend + UI
└── requirements.txt   # Python dependencies
```

## Modules

### `bl_client.py`
Client wrapper for interacting with the API, including `completion` and `embed_documents`. Handles retries, batching, and error logging.

### `parser.py`
Parses GROBID-generated TEI XML into sentence- or paragraph-level chunks and integrates CSV-based citation sentences.

### `retriever.py`
Builds FAISS indices from embedded document chunks and provides search interfaces. Supports per-paper and default global indexes.

### `nli.py`
Runs Hugging Face sequence-classification pipelines for entailment and contradiction detection. Filters predictions by configurable score thresholds.

### `utils.py`
Utility functions for text cleaning, robust CSV reading, embedding shortcuts, and best-passage selection with LLM rationale.

### `ui.py`
Streamlit-based interactive interface for file upload, model selection, segmentation via LLM, and submission to the backend API.

### `application.py`
CLI entrypoint to launch both FastAPI backend and Streamlit frontend, with health checks and logging.

## Contributing
1. Fork the repository  
2. Create a feature branch (`git checkout -b feature/XYZ`)  
3. Commit your changes (`git commit -m "Add XYZ"`)  
4. Push to your fork (`git push origin feature/XYZ`)  
5. Open a Pull Request

## License
This project is licensed under the MIT License. See `LICENSE` for details.
